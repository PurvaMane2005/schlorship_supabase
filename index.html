<!-- @format -->

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scholarship Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet" />
    <style>
      body {
        font-family: Inter, sans-serif;
        background-color: #f8fafc;
      }
      .page {
        display: none;
      }
      .page.active {
        display: block;
      }

      .sidebar-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        transition: background-color 0.2s, color 0.2s;
        color: #475569;
        font-weight: 500;
      }
      .sidebar-link svg {
        margin-right: 0.75rem;
        color: #64748b;
      }
      .sidebar-link.active,
      .sidebar-link:hover {
        background: #e0f2fe;
        color: #0c4a6e;
      }
      .sidebar-link.active svg,
      .sidebar-link:hover svg {
        color: #0ea5e9;
      }

      .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .status-submitted {
        background-color: #e0e7ff;
        color: #4338ca;
      }
      .status-approved {
        background-color: #dcfce7;
        color: #166534;
      }
      .status-disbursed {
        background-color: #cffafe;
        color: #0891b2;
      }
      .status-rejected {
        background-color: #fee2e2;
        color: #991b1b;
      }
    </style>
  </head>
  <body class="antialiased text-slate-700">
    <div id="loginPage" class="page active">
      <div class="min-h-screen flex items-center justify-center p-4">
        <div
          class="w-full max-w-sm p-8 space-y-6 bg-white rounded-2xl shadow-lg">
          <div class="text-center space-y-2">
            <svg
              class="mx-auto h-12 w-auto text-sky-600"
              xmlns="http://www.w3.org/2000/svg"
              fill="none"
              viewBox="0 0 24 24"
              stroke-width="1.5"
              stroke="currentColor">
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M4.26 10.147a60.438 60.438 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.905 59.905 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M12 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                d="M17.25 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
            </svg>
            <h2 class="text-2xl font-bold text-slate-800">
              Scholarship Portal
            </h2>
            <p class="text-sm text-slate-500">
              Select a student profile to continue
            </p>
          </div>
          <div id="login-container" class="space-y-4 pt-4">
            <p class="text-center text-sm text-slate-500">Loading...</p>
          </div>
          <div class="border-t pt-4">
            <button
              class="w-full px-4 py-2 text-white font-semibold bg-slate-700 rounded-md hover:bg-slate-800 transition-colors"
              onclick="handleGovLogin()">
              Login as Government Official
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="studentPortal" class="page">
      <div class="flex h-screen bg-slate-100">
        <div class="w-64 bg-white shadow-md flex-shrink-0">
          <div class="p-4 border-b flex items-center">
            <div class="p-2 bg-sky-100 rounded-lg">
              <svg
                class="w-8 h-8 text-sky-600"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke-width="1.5"
                stroke="currentColor">
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M4.26 10.147a60.438 60.438 0 00-.491 6.347A48.627 48.627 0 0112 20.904a48.627 48.627 0 018.232-4.41 60.46 60.46 0 00-.491-6.347m-15.482 0a50.57 50.57 0 00-2.658-.813A59.905 59.905 0 0112 3.493a59.905 59.905 0 0110.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.697 50.697 0 0112 13.489a50.702 50.702 0 017.74-3.342M6.75 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M12 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  d="M17.25 15a.75.75 0 100-1.5.75.75 0 000 1.5z" />
              </svg>
            </div>
            <h2 class="ml-3 text-xl font-bold text-slate-800">
              Student Portal
            </h2>
          </div>
          <nav id="studentSidebar" class="p-4 space-y-1"></nav>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden">
          <header
            class="flex justify-between items-center p-4 bg-white border-b">
            <h1
              id="studentPageTitle"
              class="text-xl font-semibold text-slate-800">
              Dashboard
            </h1>
            <div class="flex items-center">
              <span
                id="studentNameDisplay"
                class="mr-4 font-medium text-slate-700"></span>
              <button
                class="flex items-center px-4 py-2 text-sm text-red-600 bg-red-100 rounded-md hover:bg-red-200 transition-colors"
                onclick="logout()">
                <svg
                  class="w-4 h-4 mr-2"
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                </svg>
                Logout
              </button>
            </div>
          </header>
          <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
            <div id="studentContent">
              <p>Select a page from the sidebar.</p>
            </div>
          </main>
        </div>
      </div>
    </div>

    <div id="govPortal" class="page">
      <div class="flex h-screen bg-slate-100">
        <div class="w-64 bg-white shadow-md flex-shrink-0">
          <div class="p-4 border-b flex items-center">
            <h2 class="ml-3 text-xl font-bold text-slate-800">
              Government Portal
            </h2>
          </div>
          <nav id="govSidebar" class="p-4 space-y-1"></nav>
        </div>
        <div class="flex-1 flex flex-col overflow-hidden">
          <header
            class="flex justify-between items-center p-4 bg-white border-b">
            <h1 id="govPageTitle" class="text-xl font-semibold text-slate-800">
              Dashboard
            </h1>
            <button
              class="flex items-center px-4 py-2 text-sm text-red-600 bg-red-100 rounded-md hover:bg-red-200"
              onclick="logout()">
              Logout
            </button>
          </header>
          <main class="flex-1 overflow-x-hidden overflow-y-auto p-6">
            <div id="govContent"><p>Loading applications...</p></div>
          </main>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
      // ===================================
      // 1. SETUP & GLOBAL STATE
      // ===================================
      const SUPABASE_URL = "your url here";
      const SUPABASE_KEY = "your supabase key here";
      const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

      let currentUser = null;
      let AppData = {
        students: [],
        scholarships: [],
        applications: [],
        academicDetails: [],
        casteCategories: [],
      };

      const studentPortalConfig = {
        pages: [
          {
            id: "dashboard",
            title: "Dashboard",
            render: "renderStudentDashboard",
            icon: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25a2.25 2.25 0 01-2.25-2.25v-2.25z" /></svg>`,
          },
          {
            id: "schemes",
            title: "Available Schemes",
            render: "renderAvailableSchemes",
            icon: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg>`,
          },
          {
            id: "applications",
            title: "My Applications",
            render: "renderMyApplications",
            icon: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5A3.375 3.375 0 0010.125 2.25H5.625A1.125 1.125 0 004.5 3.375v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>`,
          },
        ],
      };

      const govPortalConfig = {
        pages: [
          {
            id: "approval",
            title: "Approval Queue",
            render: "renderApprovalQueue",
          },
          {
            id: "disbursement",
            title: "Disbursement Queue",
            render: "renderDisbursementQueue",
          },
        ],
      };

      // ===================================
      // 2. CORE LOGIC & FLOW
      // ===================================

      const byId = (id) => document.getElementById(id);

      function showPage(pageId) {
        document
          .querySelectorAll(".page")
          .forEach((p) => p.classList.remove("active"));
        byId(pageId).classList.add("active");
      }

      async function loadInitialData() {
        try {
          const [
            studentsRes,
            scholarshipsRes,
            applicationsRes,
            academicRes,
            casteRes,
          ] = await Promise.all([
            supabaseClient.from("Students").select("*"),
            supabaseClient.from("Scholarship").select("*"),
            supabaseClient.from("Application").select("*"),
            supabaseClient.from("AcademicDetails").select("*"),
            supabaseClient.from("CasteCategory").select("*"),
          ]);
          if (studentsRes.error) throw studentsRes.error;
          if (scholarshipsRes.error) throw scholarshipsRes.error;
          if (applicationsRes.error) throw applicationsRes.error;
          if (academicRes.error) throw academicRes.error;
          if (casteRes.error) throw casteRes.error;
          AppData = {
            students: studentsRes.data,
            scholarships: scholarshipsRes.data,
            applications: applicationsRes.data,
            academicDetails: academicRes.data,
            casteCategories: casteRes.data,
          };
          console.log("Data loaded:", AppData);
        } catch (error) {
          console.error("Error loading data:", error);
          alert("Could not load data from the database.");
        }
      }

      function renderLogin() {
        const loginContainer = byId("login-container");
        const selector = document.createElement("select");
        selector.id = "loginStudentSelector";
        selector.className =
          "w-full px-4 py-2 border rounded-md focus:ring-2 focus:ring-sky-500";
        AppData.students.forEach((student) => {
          const option = document.createElement("option");
          option.value = student.student_id;
          option.textContent = student.student_name;
          selector.appendChild(option);
        });
        const loginButton = document.createElement("button");
        loginButton.textContent = "Login as this Student";
        loginButton.className =
          "w-full px-4 py-2 text-white font-semibold bg-sky-600 rounded-md hover:bg-sky-700 transition-colors";
        loginButton.onclick = handleLogin;
        loginContainer.innerHTML = "";
        loginContainer.appendChild(selector);
        loginContainer.appendChild(loginButton);
      }

      function handleLogin() {
        const selectedId = byId("loginStudentSelector").value;
        currentUser = AppData.students.find((s) => s.student_id === selectedId);
        if (currentUser) {
          setupStudentPortal();
          showPage("studentPortal");
        }
      }

      function logout() {
        currentUser = null;
        renderLogin();
        showPage("loginPage");
      }

      // ===================================
      // 3. STUDENT PORTAL LOGIC
      // ===================================

      function setupStudentPortal() {
        byId("studentNameDisplay").textContent = currentUser.student_name;
        const sidebar = byId("studentSidebar");
        sidebar.innerHTML = "";
        studentPortalConfig.pages.forEach((p) => {
          const a = document.createElement("a");
          a.href = "#";
          a.className = "sidebar-link";
          a.dataset.page = p.id;
          a.innerHTML = p.icon + p.title;
          a.onclick = (e) => {
            e.preventDefault();
            navigateStudentTo(p.id);
          };
          sidebar.appendChild(a);
        });
        navigateStudentTo("dashboard");
      }

      function navigateStudentTo(pageId) {
        document
          .querySelectorAll("#studentSidebar .sidebar-link")
          .forEach((l) =>
            l.classList.toggle("active", l.dataset.page === pageId)
          );
        const page = studentPortalConfig.pages.find((p) => p.id === pageId);
        if (page && window[page.render]) {
          byId("studentPageTitle").textContent = page.title;
          window[page.render](byId("studentContent"));
        }
      }

      function checkEligibility(student, academic, scheme) {
        const reasons = [];
        if (scheme.max_income && student.annual_income > scheme.max_income) {
          reasons.push(
            `Income (₹${student.annual_income.toLocaleString(
              "en-IN"
            )}) exceeds limit (₹${scheme.max_income.toLocaleString("en-IN")})`
          );
        }
        const studentPercentage = academic ? academic.percentage_score : 0;
        if (
          scheme.min_percentage &&
          studentPercentage < scheme.min_percentage
        ) {
          reasons.push(
            `Marks (${studentPercentage}%) are below minimum (${scheme.min_percentage}%)`
          );
        }
        if (
          scheme.eligible_caste_ids &&
          scheme.eligible_caste_ids.length > 0 &&
          !scheme.eligible_caste_ids.includes(student.caste_id)
        ) {
          reasons.push(`Caste category not eligible.`);
        }
        return { isEligible: reasons.length === 0, reasons: reasons };
      }

      function renderStudentDashboard(container) {
        const academic = AppData.academicDetails.find(
          (a) => a.student_id === currentUser.student_id
        );
        const caste = AppData.casteCategories.find(
          (c) => c.caste_id === currentUser.caste_id
        );
        container.innerHTML = `
          <h2 class="text-2xl font-bold text-slate-800 mb-6">Welcome, ${
            currentUser.student_name
          }!</h2>
          <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
              <h3 class="font-semibold text-lg text-slate-800 border-b border-slate-200 pb-3 mb-4">Your Profile Details</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Student ID</span><span class="font-medium text-slate-700 font-mono text-xs">${
                    currentUser.student_id
                  }</span></div>
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Aadhaar No.</span><span class="font-medium text-slate-700">${
                    currentUser.aadhaar_no
                  }</span></div>
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Annual Income</span><span class="font-medium text-slate-700">₹${currentUser.annual_income.toLocaleString(
                    "en-IN"
                  )}</span></div>
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Caste Category</span><span class="font-medium text-slate-700">${
                    caste ? caste.caste_name : "N/A"
                  }</span></div>
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Course</span><span class="font-medium text-slate-700">${
                    academic ? academic.course_name : "N/A"
                  }</span></div>
                  <div class="flex flex-col"><span class="text-xs text-slate-500">Percentage</span><span class="font-medium text-slate-700">${
                    academic ? academic.percentage_score : "N/A"
                  }%</span></div>
              </div>
          </div>`;
      }

      function renderAvailableSchemes(container) {
        const studentApplications = AppData.applications.filter(
          (app) => app.student_id === currentUser.student_id
        );
        const appliedSchemeIds = new Set(
          studentApplications.map((app) => app.scheme_id)
        );
        const academic = AppData.academicDetails.find(
          (a) => a.student_id === currentUser.student_id
        );
        const cards = AppData.scholarships
          .map((sc) => {
            const alreadyApplied = appliedSchemeIds.has(sc.scheme_id);
            const eligibility = checkEligibility(currentUser, academic, sc);
            let statusHtml = "";
            if (alreadyApplied) {
              statusHtml = `<div class="mt-4 px-3 py-1 text-sm rounded-full bg-sky-100 text-sky-800 font-medium">Already Applied</div>`;
            } else if (eligibility.isEligible) {
              statusHtml = `<div class="mt-4 px-3 py-1 text-sm rounded-full bg-emerald-100 text-emerald-800 font-medium">✅ You are Eligible</div>`;
            } else {
              statusHtml = `<div class="mt-4 p-3 text-sm rounded-lg bg-amber-100 text-amber-800"><span class="font-bold">Not Eligible:</span><ul class="list-disc list-inside mt-1">${eligibility.reasons
                .map((r) => `<li>${r}</li>`)
                .join("")}</ul></div>`;
            }
            return `<div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 transition-all hover:shadow-md">
                <div class="flex justify-between items-start">
                    <div>
                        <h3 class="font-semibold text-lg text-slate-800">${
                          sc.scheme_name
                        }</h3>
                        <p class="text-sm text-slate-500">Deadline: ${
                          sc.last_date
                        }</p>
                    </div>
                    <button class="px-5 py-2 text-sm font-semibold text-white transition-colors ${
                      !eligibility.isEligible || alreadyApplied
                        ? "bg-slate-400 cursor-not-allowed"
                        : "bg-emerald-600 hover:bg-emerald-700"
                    } rounded-md" 
                            ${
                              !eligibility.isEligible || alreadyApplied
                                ? "disabled"
                                : ""
                            } 
                            onclick="handleApplicationSubmit(${sc.scheme_id})">
                        ${alreadyApplied ? "Applied" : "Apply Now"}
                    </button>
                </div>
                ${statusHtml}
            </div>`;
          })
          .join("");
        container.innerHTML = `<div class="space-y-4">${cards}</div>`;
      }

      function renderMyApplications(container) {
        const studentApps = AppData.applications.filter(
          (app) => app.student_id === currentUser.student_id
        );
        if (studentApps.length === 0) {
          container.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-sm text-center text-slate-500">You have not applied for any scholarships yet.</div>`;
          return;
        }
        const appItems = studentApps
          .map((app) => {
            const scheme = AppData.scholarships.find(
              (s) => s.scheme_id === app.scheme_id
            );
            const localDate = new Date(app.application_date);
            const formattedDate = localDate.toLocaleString("en-IN", {
              month: "short",
              day: "numeric",
              year: "numeric",
              hour: "numeric",
              minute: "2-digit",
              hour12: true,
            });
            const statusClass = `status-${app.status.toLowerCase()}`;
            return `<li class="bg-white p-4 rounded-lg shadow-sm border border-slate-200 flex justify-between items-center">
                <div>
                    <p class="font-semibold text-slate-800">${
                      scheme ? scheme.scheme_name : "Unknown Scheme"
                    }</p>
                    <p class="text-xs text-slate-500 mt-1">Applied on: ${formattedDate}</p>
                </div>
                <span class="status-badge ${statusClass}">${app.status}</span>
            </li>`;
          })
          .join("");
        container.innerHTML = `<ul class="space-y-4">${appItems}</ul>`;
      }

      async function handleApplicationSubmit(schemeId) {
        if (!currentUser) return alert("Please log in first.");
        const scheme = AppData.scholarships.find(
          (s) => s.scheme_id === schemeId
        );
        if (
          !confirm(
            `Are you sure you want to apply for "${scheme.scheme_name}"?`
          )
        )
          return;
        try {
          const { data, error } = await supabaseClient
            .from("Application")
            .insert({
              student_id: currentUser.student_id,
              scheme_id: schemeId,
              status: "Submitted",
            })
            .select()
            .single();
          if (error) throw error;
          AppData.applications.push(data);
          alert("Application submitted successfully!");
          navigateStudentTo("schemes");
        } catch (error) {
          console.error("Application Error:", error);
          alert(`Error submitting application: ${error.message}`);
        }
      }

      // ===================================
      // 4. GOVERNMENT PORTAL LOGIC
      // ===================================

      function handleGovLogin() {
        currentUser = { role: "government", name: "Gov Official" };
        setupGovPortal();
        showPage("govPortal");
      }

      function setupGovPortal() {
        const sidebar = byId("govSidebar");
        sidebar.innerHTML = "";
        govPortalConfig.pages.forEach((p) => {
          const a = document.createElement("a");
          a.href = "#";
          a.className = "sidebar-link";
          a.dataset.page = p.id;
          a.innerHTML = p.title;
          a.onclick = (e) => {
            e.preventDefault();
            navigateGovTo(p.id);
          };
          sidebar.appendChild(a);
        });
        navigateGovTo("approval");
      }

      function navigateGovTo(pageId) {
        document
          .querySelectorAll("#govSidebar .sidebar-link")
          .forEach((l) =>
            l.classList.toggle("active", l.dataset.page === pageId)
          );
        const page = govPortalConfig.pages.find((p) => p.id === pageId);
        if (page && window[page.render]) {
          byId("govPageTitle").textContent = page.title;
          window[page.render](byId("govContent"));
        }
      }

      function renderApprovalQueue(container) {
        const pendingApps = AppData.applications.filter(
          (app) => app.status === "Submitted"
        );
        if (pendingApps.length === 0) {
          container.innerHTML = `<div class="bg-white p-6 rounded-lg text-center text-slate-500">No applications are pending approval.</div>`;
          return;
        }
        const rows = pendingApps
          .map((app) => {
            const student = AppData.students.find(
              (s) => s.student_id === app.student_id
            );
            const scheme = AppData.scholarships.find(
              (s) => s.scheme_id === app.scheme_id
            );
            return `
            <tr class="hover:bg-slate-50">
                <td class="p-3 text-sm font-medium text-slate-800">${
                  student ? student.student_name : "Unknown"
                }</td>
                <td class="p-3 text-sm text-slate-600">${
                  scheme ? scheme.scheme_name : "Unknown"
                }</td>
                <td class="p-3 text-sm text-slate-500">${new Date(
                  app.application_date
                ).toLocaleDateString("en-IN")}</td>
                <td class="p-3 text-right space-x-2">
                    <button class="px-3 py-1 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600 transition" onclick="updateApplicationStatus('${
                      app.application_id
                    }', 'Rejected')">Reject</button>
                    <button class="px-3 py-1 text-sm font-semibold text-white bg-green-500 rounded-md hover:bg-green-600 transition" onclick="updateApplicationStatus('${
                      app.application_id
                    }', 'Approved')">Approve</button>
                </td>
            </tr>`;
          })
          .join("");
        container.innerHTML = `<div class="bg-white rounded-lg shadow-sm overflow-hidden border border-slate-200"><table class="w-full">
            <thead class="bg-slate-50 text-left text-xs uppercase text-slate-500"><th class="p-3 font-semibold">Student</th><th class="p-3 font-semibold">Scheme</th><th class="p-3 font-semibold">Date</th><th></th></thead>
            <tbody class="divide-y divide-slate-200">${rows}</tbody></table></div>`;
      }

      function renderDisbursementQueue(container) {
        const approvedApps = AppData.applications.filter(
          (app) => app.status === "Approved"
        );
        if (approvedApps.length === 0) {
          container.innerHTML = `<div class="bg-white p-6 rounded-lg text-center text-slate-500">No approved applications are awaiting disbursement.</div>`;
          return;
        }
        const rows = approvedApps
          .map((app) => {
            const student = AppData.students.find(
              (s) => s.student_id === app.student_id
            );
            const scheme = AppData.scholarships.find(
              (s) => s.scheme_id === app.scheme_id
            );
            const amount = scheme ? scheme.ug_amount_limit || 0 : 0;
            return `
            <tr class="hover:bg-slate-50">
                <td class="p-3 text-sm font-medium text-slate-800">${
                  student ? student.student_name : "Unknown"
                }</td>
                <td class="p-3 text-sm text-slate-600">${
                  scheme ? scheme.scheme_name : "Unknown"
                }</td>
                <td class="p-3 text-sm font-semibold text-emerald-600">₹${amount.toLocaleString(
                  "en-IN"
                )}</td>
                <td class="p-3 text-right">
                    <button class="px-3 py-1 text-sm font-semibold text-white bg-sky-600 rounded-md hover:bg-sky-700 transition" onclick="handleDisburse('${
                      app.application_id
                    }', ${amount})">Disburse</button>
                </td>
            </tr>`;
          })
          .join("");
        container.innerHTML = `<div class="bg-white rounded-lg shadow-sm overflow-hidden border border-slate-200"><table class="w-full">
            <thead class="bg-slate-50 text-left text-xs uppercase text-slate-500"><th class="p-3 font-semibold">Student</th><th class="p-3 font-semibold">Scheme</th><th class="p-3 font-semibold">Amount</th><th></th></thead>
            <tbody class="divide-y divide-slate-200">${rows}</tbody></table></div>`;
      }

      async function updateApplicationStatus(appId, newStatus) {
        if (
          !confirm(
            `Are you sure you want to set this application status to "${newStatus}"?`
          )
        )
          return;
        try {
          const { data, error } = await supabaseClient
            .from("Application")
            .update({ status: newStatus })
            .eq("application_id", appId)
            .select()
            .single();
          if (error) throw error;
          const appIndex = AppData.applications.findIndex(
            (a) => a.application_id === appId
          );
          if (appIndex !== -1) AppData.applications[appIndex] = data;
          alert(`Application status updated to ${newStatus}!`);
          navigateGovTo("approval");
        } catch (error) {
          alert(`Error updating status: ${error.message}`);
        }
      }

      async function handleDisburse(appId, amount) {
        if (
          !confirm(
            `Are you sure you want to disburse ₹${amount.toLocaleString(
              "en-IN"
            )}?`
          )
        )
          return;
        try {
          const { data, error } = await supabaseClient.functions.invoke(
            "smooth-function",
            {
              body: { application_id: appId, amount: amount },
            }
          );
          if (error) throw error;
          const appIndex = AppData.applications.findIndex(
            (a) => a.application_id === appId
          );
          if (appIndex !== -1) AppData.applications[appIndex] = data;
          alert("Disbursement successful!");
          navigateGovTo("disbursement");
        } catch (error) {
          alert(`Disbursement failed: ${error.message}`);
        }
      }

      // ===================================
      // 5. INITIALIZATION
      // ===================================
      async function initializeApp() {
        await loadInitialData();
        renderLogin();
        showPage("loginPage");
      }

      document.addEventListener("DOMContentLoaded", initializeApp);
    </script>
  </body>
</html>
